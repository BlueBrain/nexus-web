name: Review

on: [pull_request]

jobs:
  test-and-build:
    runs-on: it

    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v3
        with:
          cache: 'yarn'
      - name: install dependencies ðŸš€
        run: |
          yarn install --frozen-lockfile # optional, --immutable
      - name: linting âœ¨
        run: |
          yarn lint
      - name: style ðŸ’…
        run: |
          yarn style
      - name: running test ðŸ›«ðŸ›¬
        run: |
          yarn test --coverage src
      - name: upload coverage to Codecov ðŸ’Œ
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: build project ðŸ‘·
        run: |
          yarn build
      - name: build fusion docker image
        run: |
          docker build . --tag=nexus-web:latest
      - name: Start services
        run: docker-compose -f ci/docker-compose.yml up -d && sleep 60
      - name: e2e tests
        run: echo | docker exec -t cypress cypress run --config-file cypress.config.ts --browser chrome
      - name: Stop Docker
        if: ${{ always() }}
        run: docker-compose -f ci/docker-compose.yml down && sleep 60
      - name: Cleanup Docker Containers
        if: ${{ always() }}
        run: |
          for container in `docker images | grep none | awk '{print $3}'`; do
            echo "Deleting container: $container";
            docker rmi $container;
          done
