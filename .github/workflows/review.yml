name: Review

on: [pull_request]

jobs:
  test-and-build:
    runs-on: it

    steps:
      - run: docker run --rm --volume $PWD:/videos:rw bash chown -R $UID /videos
      - run: ls -la .
      - run: ls -la cypress
      - run: rm -rf cypress/videos
      - run: rm -rf cypress/screenshots
      - run: rm -rf cypress/downloads
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          cache: 'yarn'
      - name: Prune containers
        run: |
          docker system prune -af
      - name: install dependencies ðŸš€
        run: |
          yarn install --frozen-lockfile # optional, --immutable
      # - name: linting âœ¨
      #   run: |
      #     yarn lint
      # - name: style ðŸ’…
      #   run: |
      #     yarn style
      # - name: running test ðŸ›«ðŸ›¬
      #   run: |
      #     yarn test --coverage src
      # - name: upload coverage to Codecov ðŸ’Œ
      #   uses: codecov/codecov-action@v1
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      - name: build fusion docker image
        run: |
          docker build . --tag=nexus-web:fresh
      - name: Start services
        run: CYPRESS_USER=$UID docker-compose -f ci/docker-compose.yml up -d && sleep 60
      # - name: Copy nexus-web into Cypress container
      # avoids permission issue where cypress writes screenshots to host with root as user
      # which we can't then delete easily
      # run: docker cp ./. cypress:/e2e
      - name: e2e tests
        run: echo | docker exec --user ${UID} -e 'DEBUG=cypress:*' -t cypress /e2e/run-e2e.sh
      - name: Cleanup Docker Containers
        if: ${{ always() }}
        run: docker-compose -f ci/docker-compose.yml down --rmi "local" --volumes
